@model List<Library_Management_System.Models.Category>;
@{
ViewData["Title"] = "Add Book";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Add New Book</h5>
                </div>
                <div class="card-body">
                    <form id="bookForm" enctype="multipart/form-data">
                        <!-- Book Name -->
                        <div class="mb-3">
                            <label for="BookName" class="form-label">Book Name</label>
                            <input type="text" class="form-control" id="BookName" name="book_name" value="book" placeholder="Enter book name" required />
                            <span class="text-danger small" id="BookNameError"></span>
                        </div>

                        <!-- Author -->
                        <div class="mb-3">
                            <label for="Author" class="form-label">Author</label>
                            <input type="text" class="form-control" value="puskar" id="Author" name="author" placeholder="Enter author name" required />
                            <span class="text-danger small" id="AuthorError"></span>
                        </div>

                        <!-- Publisher -->
                        <div class="mb-3">
                            <label for="Publisher" class="form-label">Publisher</label>
                            <input type="text" class="form-control" id="Publisher" name="publisher" placeholder="Enter publisher" />
                            <span class="text-danger small" id="PublisherError"></span>
                        </div>

                        <!-- ISBN -->
                        <div class="mb-3">
                            <label for="ISBN" class="form-label">ISBN</label>
                            <input type="text" class="form-control" id="ISBN" name="isbn" placeholder="Enter ISBN number" />
                            <span class="text-danger small" id="ISBNError"></span>
                        </div>

                        <!-- Category -->
                        <div class="mb-3">
                            <label for="CategoryId" class="form-label">Category</label>
                            <select class="form-select" id="CategoryId" name="category_id" required>
                                <option value="">Select a category</option>
                                @foreach (var category in Model)
                                {
                                    <option value="@category.CategoryId">@category.CategoryName</option>
                                }
                                
                            </select>
                            <span class="text-danger small" id="CategoryIdError"></span>
                        </div>

                        <!-- Price -->
                        <div class="mb-3">
                            <label for="Price" class="form-label">Price</label>
                            <input type="number" step="0.01" class="form-control" id="Price" name="price" placeholder="Enter price" required />
                            <span class="text-danger small" id="PriceError"></span>
                        </div>

                        <!-- Publication Date -->
                        <div class="mb-3">
                            <label for="PublicationDate" class="form-label">Publication Date</label>
                            <input type="date" class="form-control" id="PublicationDate" name="publication_date" />
                            <span class="text-danger small" id="PublicationDateError"></span>
                        </div>

                        <!-- Quantity -->
                        <div class="mb-3">
                            <label for="Quantity" class="form-label">Quantity</label>
                            <input type="number" class="form-control" id="Quantity" name="quantity" placeholder="Enter available quantity" min="1" />
                            <span class="text-danger small" id="QuantityError"></span>
                        </div>
                        
                        <!-- Image -->
                        <div class="mb-3">
                            <label for="Image" class="form-label">Image</label>
                            <input type="file" class="form-control" id="Image" name="image" required/>
                            <span class="text-danger small" id="ImageError"></span>
                        </div>
                        <button type="submit" class="btn btn-success w-100">Add Book</button>
                    </form>

                    <div id="message" class="mt-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {


<script>
    $(document).ready(function () {
        $("#bookForm").on("submit", async(e)=> {
            e.preventDefault();
            let isValid = true;

            $("span.text-danger").text("");
            let category_id=document.getElementById("CategoryId").value;
            console.log(category_id);
            if(category_id===0||category_id==="") {
                const err = document.getElementById("CategoryIdError");
                err.val='Category is required';
                isValid = false;
                return;
            }

            $("#bookForm input, #bookForm select").each(function () {
                let input = $(this);
                let value = input.val().trim();
                let errorSpan = $("#" + input.attr("id") + "Error");

                if (input.prop("required") && value === "" || value === null) {
                    errorSpan.text("This field cannot be empty");
                    isValid = false;
                }
            });
            const file=$("#Image")[0].files[0];
            if(file===undefined){
                const err = document.getElementById("ImageError");
                err.val="Image is required";
                isValid = false;
                return;
            }else{
                const allowedTypes = ["image/jpeg", "image/jpg", "image/webp","image/png"];
                if (!allowedTypes.includes(file.type)) {
                    $("#ImageError").text("Only JPEG, JPG, and WEBP formats are allowed");
                    isValid = false;
                } else if (file.size > 2 * 1024 * 1024) { // 2MB limit
                    $("#ImageError").text("Image size must not exceed 2MB");
                    isValid = false;
                }
            }
            if(isValid){
                Swal.fire({
                    title: "Are you sure?",
                    text:"This book will be saved in database",
                    showCancelButton: true,

                }).then(async (result) => {
                    if (result.isConfirmed) {
                        try {
                            const formData = new FormData();
                            formData.append("CategoryId", category_id);
                            formData.append("BookName", $("#BookName").val());
                            formData.append("Author", $("#Author").val());
                            formData.append("Publisher", $("#Publisher").val());
                            formData.append("ISBN", $("#ISBN").val());
                            formData.append("Price", $("#Price").val());
                            formData.append("Quantity", $("#Quantity").val());
                            formData.append("PublishDate", $("#PublicationDate").val());
                            formData.append("Image", file);

                            const response = await secureFetch("/api/book-api/create", {
                                method: "POST",
                                body: formData,
                            },);
                            if (response.ok) {
                              Swal.fire({
                                  icon: "success",
                                  text: "Book has been added successfully",
                                  showConfirmButton: true,
                                  timer: 1500,
                              }).then(()=>{
                                  window.location.href = "/book";
                              });
                            } else {
                                Swal.fire({
                                    icon: "error",
                                    text: response.message || "Something went wrong",
                                    showConfirmButton: true,
                                    timer: 1500,
                                });
                              
                            }
                        } catch (error) {
                            console.log(error);
                        }
                    }
                });

            }
        });
        $("#bookForm input, #bookForm select").on("input change", function () {
            $("#" + $(this).attr("id") + "Error").text("");
        });
    });
</script>
}
